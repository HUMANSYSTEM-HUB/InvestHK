<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contrato de Activos Digitales</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

<div id="content" style="display:none;">
    <form id="contractForm">
        <label for="humanIdSender">ID de Humano (Vendedor):</label>
        <input type="text" id="humanIdSender" name="humanIdSender" required><br><br>
        <label for="humanIdReceiver">ID de Humano (Comprador):</label>
        <input type="text" id="humanIdReceiver" name="humanIdReceiver" required><br><br>
        <div id="assetsContainer"></div>
        <button type="button" onclick="addAssetField()">Añadir Activo Digital</button><br><br>
        <input type="submit" value="Generar Contrato">
    </form>
</div>

<script>
window.onload = function() {
    Swal.fire({
        title: 'Ingrese Usuario y Contraseña',
        html:
            '<input id="swal-input1" class="swal2-input" placeholder="Usuario">' +
            '<input id="swal-input2" class="swal2-input" placeholder="Contraseña" type="password">',
        focusConfirm: false,
        preConfirm: () => {
            return [
                document.getElementById('swal-input1').value,
                document.getElementById('swal-input2').value
            ]
        }
    }).then((result) => {
        if (result.value[0] === 'hashkey' && result.value[1] === 'human_xchange') {
            document.getElementById('content').style.display = 'block';
        } else {
            Swal.fire('Error', 'Usuario o Contraseña Incorrectos', 'error');
        }
    });
};

function addAssetField() {
    const container = document.getElementById('assetsContainer');
    const div = document.createElement('div');
    div.innerHTML = '<label for="assetId">ID del Activo:</label>' +
                    '<input type="text" name="assetId" required><br>' +
                    '<label for="assetPrice">Precio del Activo:</label>' +
                    '<input type="number" name="assetPrice" required><br><br>';
    container.appendChild(div);
}


document.getElementById('contractForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const humanIdSender = document.getElementById('humanIdSender').value;
    const humanIdReceiver = document.getElementById('humanIdReceiver').value;
    const tokenUnico = 'TokenUnico1234'; // Este debería ser generado de forma única para cada contrato

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text('CONTRATO DE COMPRA DE ACTIVOS DIGITALES', 20, 30);
    doc.text(`ID de Humano (Vendedor): ${humanIdSender}`, 20, 40);
    doc.text(`ID de Humano (Comprador): ${humanIdReceiver}`, 20, 50);
    doc.text(`Token Único por Contrato: ${tokenUnico}`, 20, 60);

    const assetsContainer = document.getElementById('assetsContainer');
    const assetDivs = assetsContainer.getElementsByTagName('div');
    let yOffset = 70;
    
    for (const assetDiv of assetDivs) {
        const assetIdInput = assetDiv.querySelector('input[name="assetId"]');
        const assetPriceInput = assetDiv.querySelector('input[name="assetPrice"]');
        
        const assetId = assetIdInput ? assetIdInput.value : '';
        const assetPrice = assetPriceInput ? assetPriceInput.value : '';
        
        doc.text(`ID del Activo: ${assetId}`, 20, yOffset);
        yOffset += 10;
        doc.text(`Precio del Activo: ${assetPrice}`, 20, yOffset);
        yOffset += 10;
    }

    const qrDiv = document.createElement('div');
    document.body.appendChild(qrDiv);
    new QRCode(qrDiv, { text: tokenUnico, width: 128, height: 128 });

    html2canvas(qrDiv).then((canvas) => {
    const dataURL = canvas.toDataURL('image/png');
    const qrSize = 30;
    const qrPositionX = 20;
    const qrPositionY = doc.internal.pageSize.getHeight() - qrSize - 30; // Ajustar posición en Y
    
    doc.addImage(dataURL, 'PNG', qrPositionX, qrPositionY, qrSize, qrSize); // Asegurar dimensiones cuadradas
    
    document.body.removeChild(qrDiv);
    
    doc.save('contrato.pdf');
    Swal.fire('Contrato Generado', 'El contrato ha sido generado y descargado.', 'success');
});
});
</script>

</body>
</html>

</body>
</html>
